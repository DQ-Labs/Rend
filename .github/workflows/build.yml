name: Build Rend

on:
  push:
    branches: [ "main" ]
  release:
    types: [created]

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Install FFmpeg
      run: |
        Invoke-WebRequest -Uri "https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-win64-gpl.zip" -OutFile "ffmpeg.zip"
        Expand-Archive ffmpeg.zip -DestinationPath .
        Move-Item .\ffmpeg-master-latest-win64-gpl\bin\ffmpeg.exe .
        Move-Item .\ffmpeg-master-latest-win64-gpl\bin\ffprobe.exe .
        Remove-Item -Recurse -Force ffmpeg-master-latest-win64-gpl
        Remove-Item ffmpeg.zip

    - name: Setup Demucs Source
      run: |
        git clone https://github.com/facebookresearch/demucs.git demucs_source
        
        # Patch requirements_minimal.txt
        $reqFile = "demucs_source/requirements_minimal.txt"
        $content = Get-Content $reqFile
        $content = $content | Where-Object { $_ -notmatch "lameenc" -and $_ -notmatch "torchaudio" }
        Set-Content -Path $reqFile -Value $content

        # Patch audio.py to fix lameenc import for Windows
        $audioFile = "demucs_source/demucs/audio.py"
        $audioContent = Get-Content $audioFile -Raw
        $audioContent = $audioContent -replace "import lameenc", "try:`r`n    import lameenc`r`nexcept ImportError:`r`n    pass"
        Set-Content -Path $audioFile -Value $audioContent

    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller customtkinter soundfile
        pip install -e ./demucs_source

    - name: Build Executable
      run: |
        pyinstaller Rend.spec

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: Rend-Windows-Exe
        path: dist/Rend.exe
